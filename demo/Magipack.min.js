/**
 *
 * Copyright (c) 2014 Keita Kuroki
 * Released under MIT license:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * For more information:
 * https://github.com/keitakun/Magipack.js
 * code@hellokeita.in
 *
 **/window.Magipack=function(){function b64encodeString(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";t=t.split("");var n=e.length,r=0,i=b=0,s=0,o=0,u,a,f,l,c,h,p,d="";while(r<n){u=e.charCodeAt(r+0)&255;a=e.charCodeAt(r+1)&255;f=e.charCodeAt(r+2)&255;l=u>>2&63;c=(u<<4|a>>4)&63;h=(a<<2|f>>6)&63;p=f&63;d+=t[l]+t[c]+t[h]+t[p];r+=3}r=n%3;n=d.length;r==1?d=d.substr(0,n-2)+"==":r==2&&(d=d.substr(0,n-1)+"=");return d}function req(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)return new ActiveXObject("MSXML2.XMLHTTP.3.0")}function Magipack(e,t){this.progress=0;e&&this.init(e,t)}window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;Magipack.isIE=Boolean(document.all);var hasBlob=!1;try{hasBlob=Boolean(Blob)}catch(e){hasBlob=!1}Magipack.hasBlob=hasBlob;Magipack.version="0.1";if(!Magipack.hasBlob){var s=document.createElement("script");s.type="text/vbscript";s.text='Function IEBinaryToArray_ByteStr(Binary)\n	IEBinaryToArray_ByteStr = CStr(Binary)\nEnd Function\nFunction IEBinaryToArray_ByteStr_Last(Binary)\n	Dim lastIndex\n	lastIndex = LenB(Binary)\n	if lastIndex mod 2 Then\n		IEBinaryToArray_ByteStr_Last = Chr( AscB( MidB( Binary, lastIndex, 1 ) ) )\n	Else\n		IEBinaryToArray_ByteStr_Last = ""\n	End If\nEnd Function';document.childNodes[document.childNodes.length-1].appendChild(s);function GetIEByteArray_ByteStr(e){var t={};for(var n=0;n<256;n++)for(var r=0;r<256;r++)t[String.fromCharCode(n+r*256)]=String.fromCharCode(n)+String.fromCharCode(r);var i=IEBinaryToArray_ByteStr(e),s=IEBinaryToArray_ByteStr_Last(e);return i.replace(/[\s\S]/g,function(e){return t[e]})+s}}Magipack.prototype._onProgress=function(e){p=e.position/e.totalSize;isNaN(p)&&(p=0);this._configComplete?p=p*.9+.1:p*=.1;this.progress=p;this.onProgress&&this.onProgress(p,1)};Magipack.prototype._loadFile=function(e,t,n){var r=req();if(!n){n="arraybuffer";try{Blob.prototype.slice&&(n="blob")}catch(i){}}r.open("GET",e,!0);r.responseType=n;var s=t,o=this;r.onprogress=function(e){o._onProgress(e)};r.onreadystatechange=function(e){if(this.readyState==4){s&&s.call(o,this);this.onreadystatechange=null}};r.send(null)};Magipack.prototype._configLoaded=function(e){this._configComplete=!0;this.config=eval("("+e.responseText+")");this._loadFile(this.pack,this._packLoaded)};Magipack.prototype._packLoaded=function(e){Magipack.hasBlob?this.init(e.response,this.config):this.init(e.responseBody,this.config);this.onLoadComplete&&this.onLoadComplete(this)};Magipack.prototype._findFile=function(e){var t;t=this.config.length;while(t-->0)if(this.config[t][0]==e)return this.config[t];while(t-->0)if(e.indexOf(this.config[t][0])>=0)return this.config[t]};Magipack.prototype._getRange=function(e,t,n){if(!Magipack.hasBlob){if(Magipack.isIE)return"data:"+n+";base64,"+b64encodeString(this.ieBlob.substr(e,t-e))}else{var r;if(this.blob.slice){r=this.blob.slice(e,t);return window.URL.createObjectURL(r)}if(this.blob.webkitSlice){r=this.blob.webkitSlice(e,t,n);return window.URL.createObjectURL(r)}if(this.blob.mozSlice){r=this.blob.mozSlice(e,t,n);return window.URL.createObjectURL(r)}}};Magipack.prototype.init=function(e,t){this.config=t;e!=null&&(Magipack.hasBlob?this.blob=new Blob([e]):this.ieBlob=GetIEByteArray_ByteStr(e))};Magipack.prototype.load=function(e,t){this.pack=e;t?this._loadFile(t,this._configLoaded,"text"):this._loadFile(e,this._packLoaded)};Magipack.prototype.getURI=function(){if(arguments.length==0)throw new Error("Not enough arguments.");if(isNaN(arguments[0])&&!this.config)throw new Error("No config file loaded.");var e;if(!isNaN(arguments[0])&&!isNaN(arguments[1])){e=arguments[2];e||(e="text/plain");return this._getRange(arguments[0],arguments[1],e)}var t=this._findFile(arguments[0]);if(!t)throw new Error("File not found in pack.");e=t[3];e||(e="text/plain");return this._getRange(t[1],t[2],e)};Magipack.init=function(e,t){if(this.inited)throw new Error("Magipack static instance already initialized.");this._instance=new Magipack(e,t);e&&this._instance.init(e,t);this.inited=!0};Magipack.load=function(e,t){this.inited||this.init();this._instance.onLoadComplete=this.onLoadComplete;this._instance.load(e,t)};Magipack.getURI=function(){return this._instance.getURI.apply(this._instance,arguments)};return Magipack}();